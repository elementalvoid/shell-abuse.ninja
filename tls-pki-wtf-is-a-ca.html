
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://shell-abuse.ninja/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://shell-abuse.ninja/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://shell-abuse.ninja/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://shell-abuse.ninja/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shell Abuse Atom">



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57473144-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

<meta name="author" content="Matt Klich - Chief Abuser" />
<meta name="description" content="For Ilya! Recently a conversation came up on a Slack I participate in about PKI, Certificate Authorities, mTLS, etc. and how they all fit together. Ilya had been poking around at some Kubernetes stuff and was seeking more information about how the PKI system was setup. Where the CA came from, how that applied elsewhere, etc. Some others jumped in and they all began to spew information around. And, while the vast majority of it was correct there were some miscommunications that led to bad (and wrong) statements. Not to mention there was such a flurry of typing going on that some wires got crossed. Seeking to clear it all up I wrote a long form response for him which I’ve cleaned up a bit for this post." />
<meta name="keywords" content="TLS, SSL, encryption, networking, pki, cryptography">

<meta property="og:site_name" content="Shell Abuse"/>
<meta property="og:title" content="TLS/PKI — WTF is a CA?!?!"/>
<meta property="og:description" content="For Ilya! Recently a conversation came up on a Slack I participate in about PKI, Certificate Authorities, mTLS, etc. and how they all fit together. Ilya had been poking around at some Kubernetes stuff and was seeking more information about how the PKI system was setup. Where the CA came from, how that applied elsewhere, etc. Some others jumped in and they all began to spew information around. And, while the vast majority of it was correct there were some miscommunications that led to bad (and wrong) statements. Not to mention there was such a flurry of typing going on that some wires got crossed. Seeking to clear it all up I wrote a long form response for him which I’ve cleaned up a bit for this post."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://shell-abuse.ninja/tls-pki-wtf-is-a-ca.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-02-17 14:36:00-07:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://shell-abuse.ninja/author/matt-klich-chief-abuser.html">
<meta property="article:section" content="Encryption"/>
<meta property="article:tag" content="TLS"/>
<meta property="article:tag" content="SSL"/>
<meta property="article:tag" content="encryption"/>
<meta property="article:tag" content="networking"/>
<meta property="article:tag" content="pki"/>
<meta property="article:tag" content="cryptography"/>
<meta property="og:image" content="/images/elementalvoid-avatar.png">

  <title>Shell Abuse &ndash; TLS/PKI — WTF is a CA?!?!</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://shell-abuse.ninja">
        <img src="/images/elementalvoid-avatar.png" alt="" title="">
      </a>
      <h1><a href="https://shell-abuse.ninja"></a></h1>

<p>Bending the shell to your whim - occasionally with abandon.</p>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/mattklich" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/elementalvoid" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/436190/elementalvoid" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-rss" href="//shell-abuse.ninja/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://shell-abuse.ninja">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://shell-abuse.ninja/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="tls-pki-wtf-is-a-ca"><span class="caps">TLS</span>/<span class="caps">PKI</span> &#8212; <span class="caps">WTF</span> is a <span class="caps">CA</span>?!?!</h1>
    <p>
          Posted on Sun 17 February 2019 in <a href="https://shell-abuse.ninja/category/encryption.html">Encryption</a>


        &#8226; 5 min read
    </p>
  </header>


  <div>
    <h3>Some&nbsp;backstory</h3>
<p>Ilya had been poking around at some Kubernetes stuff and was seeking more information about how the <span class="caps">PKI</span> system was setup. Where the <span class="caps">CA</span> came from, how that applied elsewhere, etc. Some others jumped in and they all began to spew information around. And, while the vast majority of it was correct there were some miscommunications that led to bad (and wrong) statements. Not to mention there was such a flurry of typing going on that some wires got crossed. Seeking to clear it all up I wrote a long form response for&nbsp;him.</p>
<p>In essence he understood how the client and server connections were handled, the purpose of server side and client side certificates were and how they were used. But he was looking for a better understanding of how it all got bootstrapped. How trust was formed at a larger scale (i.e. outside of his playground k8s&nbsp;cluster).</p>
<p>So, from here on out, pretend you&#8217;re Ilya and this is all aimed at&nbsp;you!</p>
<hr>
<h3>A short definition of <span class="caps">PKI</span></h3>
<p><span class="caps">PKI</span> stands for Public Key Infrastructure. On this everyone involved agreed. It&#8217;s a system (process and tooling) that allows for trusting parties/entities through the use of public key cryptography in order to be able to securely share&nbsp;data.</p>
<p>In public key cryptography you share with the world the public key and hold secure a private key. The public key is used for the remote party to encrypt data to send to you. The private key is used for decryption of that incoming message. <span class="caps">TLS</span>, <span class="caps">GPG</span>, etc. are all the same system underneath. They just have varying levels of metadata, validation, and tooling wrapped around&nbsp;them.</p>
<h3>So, <span class="caps">CA</span>&#8217;s and&nbsp;such&#8230;</h3>
<p>You are already familiar with the <span class="caps">CA</span> concept (and certificate chaining &#8212; one certificate signing another which then signs another and so on). You know that a <span class="caps">CA</span> is created (but are curious about the how), and &#8220;trusted&#8221; by a client (browser or other). This &#8220;trust&#8221; is established, typically, by paying someone to validate that the entity making the request isn&#8217;t falsifying information. So, once trust is established on the <span class="caps">CA</span> (root) then you implicitly trust anything that <span class="caps">CA</span>&nbsp;signs.</p>
<p>In short, a <span class="caps">CA</span> is all about trust. Trust a given <span class="caps">CA</span>? Well, then you implicitly also trust everything that is signed by&nbsp;it.</p>
<p>For a moment let&#8217;s ignore the signature aspect. We&#8217;ll come back to that in due&nbsp;time.</p>
<h3>What is the <span class="caps">CA</span>&#8217;s certificate&nbsp;then?</h3>
<p>It is a digitally signed certificate. What makes it <span class="caps">CA</span> is that it has a special marking which means it is allowed to be used for both encrypted communication and also to be used for &#8220;issuing&#8221; (signing) new certificates. The cacert.pem file you asked about (the example came from an Nginx server setup) is exactly this: a digitally signed certificate with the special&nbsp;marking.</p>
<h3>Okay .. what&#8217;s a certificate&nbsp;anyway?</h3>
<p>It&#8217;s basically a bag of data. Inside this bag of data is the public key portion of the key pair (we&#8217;ll use this to encrypt our messages before we send them). Secondly, it contains a set of metadata about the entity that &#8220;owns&#8221; the private key (see, we&#8217;re really just trying to establish ownership of the private key). The metadata is things like the owner&#8217;s name, country, business unit, etc. It should also include things like <span class="caps">DNS</span> names which are &#8220;owned&#8221; by the key owner,&nbsp;etc.</p>
<h3>But .. but .. let&#8217;s get back to the signature&nbsp;already!</h3>
<p>A digital signature is essentially the output of a mathematical function applied to the combination of the &#8220;data&#8221; and a &#8220;key&#8221;. The data is the &#8220;stuff in the cert&#8221;. The &#8220;key&#8221; of course is the private key. The output of this function is just more &#8220;data&#8221;, except this time we can apply another mathematical function on the signature data to validate that it was created with a specific private key &#8212; the private key for our <span class="caps">CA</span>. And we can do this because we have (and trust) the public key portion of the key pair. Recall that we already have a copy of the <span class="caps">CA</span> certificate (which as we said includes the public key portion of the key pair). Validation of a signature uses the message itself (here this means the stuff in the cert), the signature, and the public&nbsp;key.</p>
<h3>What about the private key&nbsp;then?</h3>
<p>The private key servers two purposes. First, as was already discussed, it is used for decryption (though it can also be used for encryption but we aren&#8217;t doing that here). Second, it is used to create a digital signature as we just&nbsp;discussed.</p>
<h3>Are we done&nbsp;yet?</h3>
<p>Coming full circle to your initial question about the <span class="caps">CA</span> and such: As we said, a <span class="caps">CA</span> certificate is special kind of certificate that is not only allowed to provide encrypted communication, it is also allowed to sign other certificates. Creating a <span class="caps">CA</span> on your own involves self-signing: meaning you use your own private key to digitally sign the data for the certificate. So, you start by creating a private key (openssl/cfssl will allow you to &#8220;create them together&#8221; &#8212; not really true, it still creates the key first). Then you create a certificate containing the public key portion of your key pair and your certificate metadata. Finally, you sign the certificate with your private&nbsp;key.</p>
<p>All your clients now need to be given this <span class="caps">CA</span> certificate in order to provide the trust&nbsp;relationship.</p>
<p>The reason that you have to have both the <span class="caps">CA</span> cert and the private key to &#8220;issue&#8221; (sign) other certificates is to establish the chain. All certificates have a piece of metadata called the &#8220;Subject&#8221;. The <span class="caps">CA</span>&#8217;s Subject is copied into the &#8220;Issuer&#8221; field on the issued (signed) certificate. This Issuer/Subject link is the&nbsp;chain.</p>
<h3>Addendum: mTLS (mutual <span class="caps">TLS</span>&nbsp;authentication)</h3>
<p>There was an extra question about clients using certificates that were issued by your <span class="caps">CA</span>. These are not being used for serving things over <span class="caps">TLS</span>; rather they&#8217;re being used as an authentication (not authorization) mechanism when then client connects to your Kubernetes <span class="caps">API</span> server. The handshake to complete authentication is too complex to bring up now (as I&#8217;m sure you&#8217;re already tired of reading) but essentially the client sends its certificate (signed by the server&#8217;s <span class="caps">CA</span>) and a message signed by the client&#8217;s private key. Because the server was the Issuer it is able to validate the client certificate&#8217;s signature and also the signature sent (because it now has, and trusts, the client&#8217;s public key). Because of this validation the server knows that the client is who (what?) it says it is and it accepts the connection. Authorization needs to be handled separately; this just establishes an authenticated, trust, encrypted communication&nbsp;channel.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://shell-abuse.ninja/tag/tls.html">TLS</a>
      <a href="https://shell-abuse.ninja/tag/ssl.html">SSL</a>
      <a href="https://shell-abuse.ninja/tag/encryption.html">encryption</a>
      <a href="https://shell-abuse.ninja/tag/networking.html">networking</a>
      <a href="https://shell-abuse.ninja/tag/pki.html">pki</a>
      <a href="https://shell-abuse.ninja/tag/cryptography.html">cryptography</a>
    </p>
  </div>



  <div class="related-posts">
    <h4>    You might enjoy
</h4>
    <ul class="related-posts">
      <li><a href="https://shell-abuse.ninja/capturing-and-filtering-sip_rtp-data-with-tshark.html">Capturing and filtering <span class="caps">SIP</span>/<span class="caps">RTP</span> data with&nbsp;tshark</a></li>
      <li><a href="https://shell-abuse.ninja/ip-address-associated-with-the-default-route.html"><span class="caps">IP</span> address associated with the default&nbsp;route</a></li>
    </ul>
  </div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'shellabuse';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Shell Abuse ",
  "url" : "https://shell-abuse.ninja",
  "image": "/images/elementalvoid-avatar.png",
  "description": ""
}
</script>

</body>
</html>